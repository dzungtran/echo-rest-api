<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="897px" preserveAspectRatio="none" style="width:811px;height:897px;background:#FFFFFF;" version="1.1" viewBox="0 0 811 897" width="811px" zoomAndPan="magnify"><defs><filter height="300%" id="f1noai9rker6lp" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="277" x="264.75" y="29.4023">Echo rest API sequence diagram</text><rect fill="#DDDDDD" height="850.0508" style="stroke:#A80036;stroke-width:1.0;" width="374" x="431.5" y="41.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="88" x="574.5" y="53.7676">Echo rest API</text><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="173.5186" style="stroke:#A80036;stroke-width:1.0;" width="10" x="135.5" y="170.3086"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="442.9346" style="stroke:#A80036;stroke-width:1.0;" width="10" x="245" y="343.8271"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="102.2422" style="stroke:#A80036;stroke-width:1.0;" width="10" x="361" y="199.6191"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="64.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="361" y="501.3457"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="143.8633" style="stroke:#A80036;stroke-width:1.0;" width="10" x="502.5" y="456.7246"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="99.5869" style="stroke:#A80036;stroke-width:1.0;" width="10" x="614" y="600.5879"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="41.9658" style="stroke:#A80036;stroke-width:1.0;" width="10" x="744" y="700.1748"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="34" x2="34" y1="123.6875" y2="804.7617"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="140.5" x2="140.5" y1="123.6875" y2="804.7617"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="249.5" x2="249.5" y1="123.6875" y2="804.7617"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="365.5" x2="365.5" y1="123.6875" y2="804.7617"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="507.5" x2="507.5" y1="123.6875" y2="804.7617"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="618.5" x2="618.5" y1="123.6875" y2="804.7617"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="748.5" x2="748.5" y1="123.6875" y2="804.7617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="16" y="120.7344">User</text><ellipse cx="34.5" cy="50.1992" fill="#FEFECE" filter="url(#f1noai9rker6lp)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M34.5,58.1992 L34.5,85.1992 M21.5,66.1992 L47.5,66.1992 M34.5,85.1992 L21.5,100.1992 M34.5,85.1992 L47.5,100.1992 " fill="none" filter="url(#f1noai9rker6lp)" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="16" y="817.2969">User</text><ellipse cx="34.5" cy="830.25" fill="#FEFECE" filter="url(#f1noai9rker6lp)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M34.5,838.25 L34.5,865.25 M21.5,846.25 L47.5,846.25 M34.5,865.25 L21.5,880.25 M34.5,865.25 L47.5,880.25 " fill="none" filter="url(#f1noai9rker6lp)" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="102" x="87.5" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="94.5" y="92.2461">Login Screen</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="0" x="140.5" y="108.7344"/><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="102" x="87.5" y="803.7617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88" x="94.5" y="824.2969">Login Screen</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="0" x="140.5" y="840.7852"/><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="89" x="203.5" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="210.5" y="92.2461">Dashboard</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="0" x="250" y="108.7344"/><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="89" x="203.5" y="803.7617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="210.5" y="824.2969">Dashboard</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="0" x="250" y="840.7852"/><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="115" x="306.5" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="334.5" y="92.2461">Auth API</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="313.5" y="108.7344">(Kratos Server)</text><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="115" x="306.5" y="803.7617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="334.5" y="824.2969">Auth API</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="313.5" y="840.7852">(Kratos Server)</text><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="140" x="435.5" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126" x="442.5" y="92.2461">Authn middleware</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="456.5" y="108.7344">(Kratos Client)</text><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="140" x="435.5" y="803.7617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126" x="442.5" y="824.2969">Authn middleware</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="456.5" y="840.7852">(Kratos Client)</text><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="55" x="589.5" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="596.5" y="92.2461">Authz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="597.5" y="108.7344">(OPA)</text><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="55" x="589.5" y="803.7617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="596.5" y="824.2969">Authz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="597.5" y="840.7852">(OPA)</text><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="101" x="696.5" y="71.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="703.5" y="92.2461">API Handlers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="0" x="749" y="108.7344"/><rect fill="#FEFECE" filter="url(#f1noai9rker6lp)" height="46.9766" style="stroke:#A80036;stroke-width:1.5;" width="101" x="696.5" y="803.7617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="703.5" y="824.2969">API Handlers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="0" x="749" y="840.7852"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="173.5186" style="stroke:#A80036;stroke-width:1.0;" width="10" x="135.5" y="170.3086"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="442.9346" style="stroke:#A80036;stroke-width:1.0;" width="10" x="245" y="343.8271"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="102.2422" style="stroke:#A80036;stroke-width:1.0;" width="10" x="361" y="199.6191"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="64.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="361" y="501.3457"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="143.8633" style="stroke:#A80036;stroke-width:1.0;" width="10" x="502.5" y="456.7246"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="99.5869" style="stroke:#A80036;stroke-width:1.0;" width="10" x="614" y="600.5879"/><rect fill="#FFFFFF" filter="url(#f1noai9rker6lp)" height="41.9658" style="stroke:#A80036;stroke-width:1.0;" width="10" x="744" y="700.1748"/><polygon fill="#A80036" points="123.5,166.3086,133.5,170.3086,123.5,174.3086,127.5,170.3086" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="34.5" x2="129.5" y1="170.3086" y2="170.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="41.5" y="157.9111">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="32" x="54.5" y="150.2559">Enter</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="54.5" y="165.5664">credentials</text><polygon fill="#A80036" points="349,195.6191,359,199.6191,349,203.6191,353,199.6191" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="145.5" x2="355" y1="199.6191" y2="199.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="152.5" y="194.877">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="90" x="165.5" y="194.877">Request log in</text><line style="stroke:#A80036;stroke-width:1.0;" x1="371" x2="413" y1="244.2402" y2="244.2402"/><line style="stroke:#A80036;stroke-width:1.0;" x1="413" x2="413" y1="244.2402" y2="257.2402"/><line style="stroke:#A80036;stroke-width:1.0;" x1="372" x2="413" y1="257.2402" y2="257.2402"/><polygon fill="#A80036" points="382,253.2402,372,257.2402,382,261.2402,378,257.2402" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="378" y="231.8428">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="391" y="224.1875">Verify user</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="391" y="239.498">credentials</text><polygon fill="#A80036" points="156.5,297.8613,146.5,301.8613,156.5,305.8613,152.5,301.8613" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="150.5" x2="365" y1="301.8613" y2="301.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="162.5" y="289.4639">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="95" x="175.5" y="281.8086">Retrive session</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="175.5" y="297.1191">cookies</text><polygon fill="#A80036" points="233,339.8271,243,343.8271,233,347.8271,237,343.8271" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="140.5" x2="239" y1="343.8271" y2="343.8271"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="147.5" y="339.085">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="51" x="160.5" y="339.085">Redirect</text><path d="M5,314.8613 L5,354.8613 L127,354.8613 L127,324.8613 L117,314.8613 L5,314.8613 " fill="#FBFB77" filter="url(#f1noai9rker6lp)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M117,314.8613 L117,324.8613 L127,324.8613 L117,314.8613 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="11" y="332.4297">Write down</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="11" y="347.7402">session cookies</text><polygon fill="#A80036" points="490.5,452.7246,500.5,456.7246,490.5,460.7246,494.5,456.7246" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="255" x2="496.5" y1="456.7246" y2="456.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="262" y="429.0166">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="275" y="406.0508">Send requests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="50" x="275" y="421.3613">(include</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="275" y="436.6719">session</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="275" y="451.9824">cookies)</text><polygon fill="#A80036" points="382,497.3457,372,501.3457,382,505.3457,378,501.3457" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="376" x2="501.5" y1="501.3457" y2="501.3457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="388" y="488.9482">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="50" x="401" y="481.293">Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77" x="401" y="496.6035">identity info</text><polygon fill="#A80036" points="490.5,562.2773,500.5,566.2773,490.5,570.2773,494.5,566.2773" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="366" x2="496.5" y1="566.2773" y2="566.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="373" y="546.2246">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="50" x="386" y="530.9141">Retrieve</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="386" y="546.2246">identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="386" y="561.5352">information</text><path d="M517,514.3457 L517,569.3457 L777,569.3457 L777,524.3457 L767,514.3457 L517,514.3457 " fill="#FBFB77" filter="url(#f1noai9rker6lp)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M767,514.3457 L767,524.3457 L777,524.3457 L767,514.3457 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="523" y="531.9141">If retrieve identity info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="523" y="547.2246">then query user info from DB by email</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="523" y="562.5352">and set it to request context</text><polygon fill="#A80036" points="602,596.5879,612,600.5879,602,604.5879,606,600.5879" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="507.5" x2="608" y1="600.5879" y2="600.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="514.5" y="595.8457">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="57" x="527.5" y="595.8457">Continue</text><line style="stroke:#A80036;stroke-width:1.0;" x1="624" x2="666" y1="645.209" y2="645.209"/><line style="stroke:#A80036;stroke-width:1.0;" x1="666" x2="666" y1="645.209" y2="658.209"/><line style="stroke:#A80036;stroke-width:1.0;" x1="625" x2="666" y1="658.209" y2="658.209"/><polygon fill="#A80036" points="635,654.209,625,658.209,635,662.209,631,658.209" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="631" y="632.8115">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80" x="653" y="625.1563">Process rego</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="31" x="653" y="640.4668">rules</text><polygon fill="#A80036" points="732,696.1748,742,700.1748,732,704.1748,736,700.1748" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="619" x2="738" y1="700.1748" y2="700.1748"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="626" y="695.4326">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="57" x="648" y="695.4326">Continue</text><path d="M409,671.209 L409,711.209 L605,711.209 L605,681.209 L595,671.209 L409,671.209 " fill="#FBFB77" filter="url(#f1noai9rker6lp)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M595,671.209 L595,681.209 L605,681.209 L595,671.209 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="415" y="688.7773">Give permission to user</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="415" y="704.0879">to continue process actions</text><polygon fill="#A80036" points="266,738.1406,256,742.1406,266,746.1406,262,742.1406" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="260" x2="748" y1="742.1406" y2="742.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="272" y="737.3984">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="294" y="737.3984">Return results</text><polygon fill="#A80036" points="45.5,782.7617,35.5,786.7617,45.5,790.7617,41.5,786.7617" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="39.5" x2="249" y1="786.7617" y2="786.7617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="51.5" y="774.3643">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="73.5" y="766.709">Display result.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="33" x="73.5" y="782.0195">Done</text><!--MD5=[5d31fb21b9148795b5b38cfa0f4c0d74]
@startuml request_flow
title Echo rest API sequence diagram

autonumber
skinparam maxMessageSize 100

actor "User" as user
participant "Login Screen\n" as login_scr
participant "Dashboard\n" as dashboard
participant "Auth API\n(Kratos Server)" as authn_api

box "Echo rest API"
participant "Authn middleware\n(Kratos Client)" as authn_midd
participant "Authz\n(OPA)" as authz_opa
participant "API Handlers\n" as api_handlers
end box

user -> login_scr : Enter credentials
activate login_scr
login_scr -> authn_api : Request log in
activate authn_api
authn_api -> authn_api : Verify user credentials
authn_api -> login_scr : Retrive session cookies
deactivate authn_api
login_scr -> dashboard : Redirect
note left: Write down \nsession cookies
deactivate login_scr
activate dashboard

|||
dashboard -> authn_midd: Send requests (include session cookies)
activate authn_midd
authn_midd -> authn_api: Request identity info
activate authn_api
authn_api -> authn_midd: Retrieve identity information
deactivate authn_api
note right: If retrieve identity info \nthen query user info from DB by email\nand set it to request context
authn_midd -> authz_opa: Continue
deactivate authn_midd
activate authz_opa
authz_opa -> authz_opa: Process rego rules
authz_opa -> api_handlers: Continue
note left: Give permission to user\nto continue process actions 
deactivate authz_opa
activate api_handlers

api_handlers -> dashboard : Return results
deactivate api_handlers
dashboard -> user : Display result. Done
deactivate dashboard

@enduml

PlantUML version 1.2022.0(Tue Jan 11 23:16:42 ICT 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: VN
--></g></svg>