<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="868px" preserveAspectRatio="none" style="width:792px;height:868px;background:#FFFFFF;" version="1.1" viewBox="0 0 792 868" width="792px" zoomAndPan="magnify"><defs/><g><rect height="26.2969" style="stroke:#00000000;stroke-width:1.0;fill:none;" width="273" x="256.5" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="263" x="261.5" y="27.9951">Echo REST API sequence diagram</text><rect fill="#DDDDDD" height="819.0469" style="stroke:#181818;stroke-width:0.5;" width="366" x="420" y="43.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="105" x="550.5" y="55.3638">Echo REST API</text><rect fill="#FFFFFF" height="170.3633" style="stroke:#181818;stroke-width:1.0;" width="10" x="131" y="164.8594"/><rect fill="#FFFFFF" height="429.8242" style="stroke:#181818;stroke-width:1.0;" width="10" x="238" y="335.2227"/><rect fill="#FFFFFF" height="101.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="351" y="193.9922"/><rect fill="#FFFFFF" height="62.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="351" y="489.5859"/><rect fill="#FFFFFF" height="138.7969" style="stroke:#181818;stroke-width:1.0;" width="10" x="488" y="445.3203"/><rect fill="#FFFFFF" height="96.9648" style="stroke:#181818;stroke-width:1.0;" width="10" x="594" y="584.1172"/><rect fill="#FFFFFF" height="39.6992" style="stroke:#181818;stroke-width:1.0;" width="10" x="727" y="681.082"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="29" x2="29" y1="118.5938" y2="783.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="136" x2="136" y1="118.5938" y2="783.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="243" x2="243" y1="118.5938" y2="783.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="356" x2="356" y1="118.5938" y2="783.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="493" x2="493" y1="118.5938" y2="783.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="599" x2="599" y1="118.5938" y2="783.0469"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="732" x2="732" y1="118.5938" y2="783.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="10" y="115.292">User</text><ellipse cx="29" cy="50.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M29,58.7969 L29,85.7969 M16,66.7969 L42,66.7969 M29,85.7969 L16,100.7969 M29,85.7969 L42,100.7969 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="10" y="795.042">User</text><ellipse cx="29" cy="806.8438" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M29,814.8438 L29,841.8438 M16,822.8438 L42,822.8438 M29,841.8438 L16,856.8438 M29,841.8438 L42,856.8438 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="84" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="90" x="91" y="90.9951">Login Screen</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="134" y="107.292"> </text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="104" x="84" y="782.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="90" x="91" y="802.042">Login Screen</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="134" y="818.3389"> </text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="90" x="198" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76" x="205" y="90.9951">Dashboard</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="241" y="107.292"> </text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="90" x="198" y="782.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76" x="205" y="802.042">Dashboard</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="241" y="818.3389"> </text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="116" x="298" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="327.5" y="90.9951">Auth API</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102" x="305" y="107.292">(Kratos Server)</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="116" x="298" y="782.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="327.5" y="802.042">Auth API</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102" x="305" y="818.3389">(Kratos Server)</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="138" x="424" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="124" x="431" y="90.9951">Authn middleware</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="97" x="444.5" y="107.292">(Kratos Client)</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="138" x="424" y="782.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="124" x="431" y="802.042">Authn middleware</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="97" x="444.5" y="818.3389">(Kratos Client)</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="54" x="572" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="579" y="90.9951">Authz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="579.5" y="107.292">(OPA)</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="54" x="572" y="782.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="579" y="802.042">Authz</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="579.5" y="818.3389">(OPA)</text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100" x="682" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="689" y="90.9951">API Handlers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="730" y="107.292"> </text><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100" x="682" y="782.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="689" y="802.042">API Handlers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="730" y="818.3389"> </text><rect fill="#FFFFFF" height="170.3633" style="stroke:#181818;stroke-width:1.0;" width="10" x="131" y="164.8594"/><rect fill="#FFFFFF" height="429.8242" style="stroke:#181818;stroke-width:1.0;" width="10" x="238" y="335.2227"/><rect fill="#FFFFFF" height="101.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="351" y="193.9922"/><rect fill="#FFFFFF" height="62.3984" style="stroke:#181818;stroke-width:1.0;" width="10" x="351" y="489.5859"/><rect fill="#FFFFFF" height="138.7969" style="stroke:#181818;stroke-width:1.0;" width="10" x="488" y="445.3203"/><rect fill="#FFFFFF" height="96.9648" style="stroke:#181818;stroke-width:1.0;" width="10" x="594" y="584.1172"/><rect fill="#FFFFFF" height="39.6992" style="stroke:#181818;stroke-width:1.0;" width="10" x="727" y="681.082"/><polygon fill="#181818" points="119,160.8594,129,164.8594,119,168.8594,123,164.8594" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="29" x2="125" y1="164.8594" y2="164.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="36" y="152.2271">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="49" y="144.6606">Enter</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="49" y="159.7935">credentials</text><polygon fill="#181818" points="339,189.9922,349,193.9922,339,197.9922,343,193.9922" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="141" x2="345" y1="193.9922" y2="193.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="148" y="188.9263">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="90" x="161" y="188.9263">Request log in</text><line style="stroke:#181818;stroke-width:1.0;" x1="361" x2="403" y1="238.2578" y2="238.2578"/><line style="stroke:#181818;stroke-width:1.0;" x1="403" x2="403" y1="238.2578" y2="251.2578"/><line style="stroke:#181818;stroke-width:1.0;" x1="362" x2="403" y1="251.2578" y2="251.2578"/><polygon fill="#181818" points="372,247.2578,362,251.2578,372,255.2578,368,251.2578" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="368" y="225.6255">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="381" y="218.0591">Verify user</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="70" x="381" y="233.1919">credentials</text><polygon fill="#181818" points="152,291.5234,142,295.5234,152,299.5234,148,295.5234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="146" x2="355" y1="295.5234" y2="295.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="158" y="282.8911">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="171" y="275.3247">Retrive session</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="171" y="290.4575">cookies</text><polygon fill="#181818" points="226,331.2227,236,335.2227,226,339.2227,230,335.2227" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="136" x2="232" y1="335.2227" y2="335.2227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="143" y="330.1567">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="156" y="330.1567">Redirect</text><path d="M5,308.5234 L5,348.5234 L126,348.5234 L126,318.5234 L116,308.5234 L5,308.5234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M116,308.5234 L116,318.5234 L126,318.5234 L116,308.5234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="69" x="11" y="325.5903">Write down</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="11" y="340.7231">session cookies</text><polygon fill="#181818" points="476,441.3203,486,445.3203,476,449.3203,480,445.3203" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="248" x2="482" y1="445.3203" y2="445.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="255" y="417.5552">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="268" y="394.856">Send requests</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="50" x="268" y="409.9888">(include</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="48" x="268" y="425.1216">session</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="268" y="440.2544">cookies)</text><polygon fill="#181818" points="372,485.5859,362,489.5859,372,493.5859,368,489.5859" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="366" x2="487" y1="489.5859" y2="489.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="378" y="476.9536">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="391" y="469.3872">Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="391" y="484.52">identity info</text><polygon fill="#181818" points="476,547.9844,486,551.9844,476,555.9844,480,551.9844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="356" x2="482" y1="551.9844" y2="551.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="363" y="531.7856">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="376" y="516.6528">Retrieve</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="376" y="531.7856">identity</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="73" x="376" y="546.9185">information</text><path d="M503,502.5859 L503,557.5859 L767,557.5859 L767,512.5859 L757,502.5859 L503,502.5859 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M757,502.5859 L757,512.5859 L767,512.5859 L757,502.5859 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="509" y="519.6528">If retrieve identity info</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="243" x="509" y="534.7856">then query user info from DB by email</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="509" y="549.9185">and set it to request context</text><polygon fill="#181818" points="582,580.1172,592,584.1172,582,588.1172,586,584.1172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="493" x2="588" y1="584.1172" y2="584.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="500" y="579.0513">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="57" x="513" y="579.0513">Continue</text><line style="stroke:#181818;stroke-width:1.0;" x1="604" x2="646" y1="628.3828" y2="628.3828"/><line style="stroke:#181818;stroke-width:1.0;" x1="646" x2="646" y1="628.3828" y2="641.3828"/><line style="stroke:#181818;stroke-width:1.0;" x1="605" x2="646" y1="641.3828" y2="641.3828"/><polygon fill="#181818" points="615,637.3828,605,641.3828,615,645.3828,611,641.3828" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="611" y="615.7505">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="83" x="633" y="608.1841">Process rego</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="31" x="633" y="623.3169">rules</text><polygon fill="#181818" points="715,677.082,725,681.082,715,685.082,719,681.082" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="599" x2="721" y1="681.082" y2="681.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="606" y="676.0161">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="57" x="628" y="676.0161">Continue</text><path d="M392,654.3828 L392,694.3828 L589,694.3828 L589,664.3828 L579,654.3828 L392,654.3828 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M579,654.3828 L579,664.3828 L589,664.3828 L579,654.3828 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="398" y="671.4497">Give permission to user</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="176" x="398" y="686.5825">to continue process actions</text><polygon fill="#181818" points="259,716.7813,249,720.7813,259,724.7813,255,720.7813" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="253" x2="731" y1="720.7813" y2="720.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="265" y="715.7153">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="287" y="715.7153">Return results</text><polygon fill="#181818" points="40,761.0469,30,765.0469,40,769.0469,36,765.0469" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="34" x2="242" y1="765.0469" y2="765.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="46" y="752.4146">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="90" x="68" y="744.8481">Display result.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="68" y="759.981">Done</text><!--MD5=[8121aeefe18da7e690a5560e53b6612b]
@startuml request_flow
title Echo REST API sequence diagram

autonumber
skinparam maxMessageSize 100

actor "User" as user
participant "Login Screen\n" as login_scr
participant "Dashboard\n" as dashboard
participant "Auth API\n(Kratos Server)" as authn_api

box "Echo REST API"
participant "Authn middleware\n(Kratos Client)" as authn_midd
participant "Authz\n(OPA)" as authz_opa
participant "API Handlers\n" as api_handlers
end box

user -> login_scr : Enter credentials
activate login_scr
login_scr -> authn_api : Request log in
activate authn_api
authn_api -> authn_api : Verify user credentials
authn_api -> login_scr : Retrive session cookies
deactivate authn_api
login_scr -> dashboard : Redirect
note left: Write down \nsession cookies
deactivate login_scr
activate dashboard

|||
dashboard -> authn_midd: Send requests (include session cookies)
activate authn_midd
authn_midd -> authn_api: Request identity info
activate authn_api
authn_api -> authn_midd: Retrieve identity information
deactivate authn_api
note right: If retrieve identity info \nthen query user info from DB by email\nand set it to request context
authn_midd -> authz_opa: Continue
deactivate authn_midd
activate authz_opa
authz_opa -> authz_opa: Process rego rules
authz_opa -> api_handlers: Continue
note left: Give permission to user\nto continue process actions 
deactivate authz_opa
activate api_handlers

api_handlers -> dashboard : Return results
deactivate api_handlers
dashboard -> user : Display result. Done
deactivate dashboard

@enduml

PlantUML version 1.2022.5(Sat Apr 30 10:55:52 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: ANSI_X3.4-1968
Language: en
Country: US
--></g></svg>